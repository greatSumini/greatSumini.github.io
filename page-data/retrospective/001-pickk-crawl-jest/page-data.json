{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/retrospective/001-pickk-crawl-jest/","result":{"data":{"site":{"siteMetadata":{"title":"최수민 개발 블로그","siteUrl":"https://sumini.dev"}},"markdownRemark":{"id":"58ac9f9c-330d-57f5-b598-4e5e81e0478f","excerpt":"핔 크롤러가 뭔가요? 핔 서비스에서 사용되는 아이템의 이름, 가격, 옵션, 품절 여부, 추가 금액등의 정보들을 크롤링합니다. Node.js + Typescript로 작성했고, Cheerio를 사용하며, Vercel Serverless…","html":"<h2 id=\"핔-크롤러가-뭔가요\" style=\"position:relative;\"><a href=\"#%ED%95%94-%ED%81%AC%EB%A1%A4%EB%9F%AC%EA%B0%80-%EB%AD%94%EA%B0%80%EC%9A%94\" aria-label=\"핔 크롤러가 뭔가요 permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>핔 크롤러가 뭔가요?</h2>\n<p><a href=\"https://pickk.one\">핔</a> 서비스에서 사용되는 아이템의 이름, 가격, 옵션, 품절 여부, 추가 금액등의 정보들을 크롤링합니다.</p>\n<p>Node.js + Typescript로 작성했고, Cheerio를 사용하며, Vercel Serverless로 배포했습니다.</p>\n<ul>\n<li><a href=\"https://github.com/pickk-dev/pickk-crawl\">깃헙 레포지토리</a></li>\n</ul>\n<h2 id=\"왜-갑자기-테스트를-도입했나요\" style=\"position:relative;\"><a href=\"#%EC%99%9C-%EA%B0%91%EC%9E%90%EA%B8%B0-%ED%85%8C%EC%8A%A4%ED%8A%B8%EB%A5%BC-%EB%8F%84%EC%9E%85%ED%96%88%EB%82%98%EC%9A%94\" aria-label=\"왜 갑자기 테스트를 도입했나요 permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>왜 갑자기 테스트를 도입했나요?</h2>\n<p>크롤링은 굉장히 불안정한 작업입니다.</p>\n<p>잘 작동하던 완벽한 크롤러도 다음 사유로 인해 갑자기 에러가 날 수 있습니다.</p>\n<ol>\n<li>대상 웹페이지의 구조가 바뀜</li>\n<li>크롤링을 시도하는 순간 네트워크 상태가 불량함</li>\n<li>대상 웹서버의 보안이 강화됨</li>\n<li>대상 웹서버의 응답 속도가 느려짐 (timeout 발생)</li>\n</ol>\n<p>따라서 우리는 크롤러를 작성한 이후에 계속해서 <strong>‘잘 작동하는지’</strong> 점검해줄 필요가 있습니다.</p>\n<p>몇백개의 웹사이트에 대해서 일일이 수동으로 상품 URL을 넣어 보고 결과를 확인하는 것은 말이 안 되죠.</p>\n<p>자동화된 테스트로 튼튼한 CI를 구축해야 합니다.</p>\n<h2 id=\"첫-번째-버전--잘-작동하지만-성능이\" style=\"position:relative;\"><a href=\"#%EC%B2%AB-%EB%B2%88%EC%A7%B8-%EB%B2%84%EC%A0%84--%EC%9E%98-%EC%9E%91%EB%8F%99%ED%95%98%EC%A7%80%EB%A7%8C-%EC%84%B1%EB%8A%A5%EC%9D%B4\" aria-label=\"첫 번째 버전  잘 작동하지만 성능이 permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>첫 번째 버전 : 잘 작동하지만 성능이..?</h2>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token comment\">// /__tests__/service/info.test.ts</span>\n<span class=\"token keyword\">import</span> InfoCrawlService <span class=\"token keyword\">from</span> <span class=\"token string\">'../../services/info'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> testCases <span class=\"token keyword\">from</span> <span class=\"token string\">'../test-cases.json'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">describe</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Test brands'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">const</span> testCase <span class=\"token keyword\">of</span> testCases<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> name<span class=\"token punctuation\">,</span> url<span class=\"token punctuation\">,</span> isPartner <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> testCase<span class=\"token punctuation\">;</span>\n    <span class=\"token function\">it</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>done<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> infoCrawlService <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InfoCrawlService</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> infoCrawlService<span class=\"token punctuation\">.</span><span class=\"token function\">crawl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>brandKor<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBeGreaterThan</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBeGreaterThan</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>imageUrl<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBeGreaterThan</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>originalPrice<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBeGreaterThan</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>salePrice<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBeGreaterThan</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isPartner<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>images<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBeGreaterThan</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token function\">done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br>\n<p>가장 직관적인 초기 버전입니다.</p>\n<p>for문으로 testCases를 순회하며 it(테스트)를 생성합니다.</p>\n<p>정말 잘 작동하지만, 한가지 문제가 있는데요.</p>\n<p>jest의 테스팅 환경에서 각 테스트는 <del>무조건 순차적으로 실행</del>되기 때문에 <del>A크롤링-B크롤링-C크롤링-…</del> 과 같이 프로세스가 직렬적으로 이어져, 테스트 케이스가 늘어남에따라 실행시간이 선형적으로 증가합니다.</p>\n<p>웹페이지 1개를 fetch하는 데에 평균 3초 정도 소요되니 10개면 30초, 100개면 300초…</p>\n<p>프로세스를 병렬적으로 개선해야만 했습니다.</p>\n<h2 id=\"병렬-처리--promiseall\" style=\"position:relative;\"><a href=\"#%EB%B3%91%EB%A0%AC-%EC%B2%98%EB%A6%AC--promiseall\" aria-label=\"병렬 처리  promiseall permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>병렬 처리 : Promise.all</h2>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token comment\">// /__tests__/service/info.test.ts</span>\n<span class=\"token keyword\">import</span> InfoCrawlService <span class=\"token keyword\">from</span> <span class=\"token string\">'../../services/info'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> testCases <span class=\"token keyword\">from</span> <span class=\"token string\">'../test-cases.json'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">let</span> datas<span class=\"token punctuation\">;</span>\n<span class=\"token function\">beforeAll</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  datas <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token builtin\">Promise</span><span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span>\n    testCases<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>\n      <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> url <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n        <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token builtin\">Promise</span></span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n          <span class=\"token keyword\">const</span> infoCrawlService <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">InfoCrawlService</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> infoCrawlService<span class=\"token punctuation\">.</span><span class=\"token function\">crawl</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n          <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span>\n  <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">describe</span><span class=\"token punctuation\">(</span><span class=\"token string\">'Test brands'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> i <span class=\"token operator\">=</span> <span class=\"token number\">0</span><span class=\"token punctuation\">;</span> i <span class=\"token operator\">&lt;</span> testCases<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">;</span> <span class=\"token operator\">++</span>i<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> name<span class=\"token punctuation\">,</span> isPartner <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> testCases<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">it</span><span class=\"token punctuation\">(</span>name<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span>done<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">const</span> data <span class=\"token operator\">=</span> datas<span class=\"token punctuation\">[</span>i<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBeTruthy</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>brandKor<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBeGreaterThan</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>name<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBeGreaterThan</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>imageUrl<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBeGreaterThan</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>originalPrice<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBeGreaterThan</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>salePrice<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBeGreaterThan</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>isPartner<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token function\">expect</span><span class=\"token punctuation\">(</span>data<span class=\"token punctuation\">.</span>images<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toBeGreaterThan</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n      <span class=\"token function\">done</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<br>\n<p>Fetch 프로세스를 병렬화해 개선한 두번째 버전입니다.</p>\n<p>beforeAll은 말 그대로 모든 테스트를 실행하기 전에 전역으로 1번 실행되는 함수인데요, 여기서 모든 데이터를 미리 fetch 해놓고 테스팅 과정에선 가져다 쓰기만 하고 있습니다.</p>\n<p>무지막지하게 오래 걸리던 실행 시간이 5~15초로 단축됐습니다! 👏👏👏</p>\n<p>하지만 또 문제가 있었습니다.</p>\n<ol>\n<li>\n<p>느리거나 접속이 안 되는 사이트들이 프로세스를 오랫동안 붙잡고 있다가 timeout 에러를 발생시켰습니다.<br>\nPromise.all은 모든 작업을 동시에 끝내기 때문에, 다른 사이트들의 데이터들도 같이 기다려야만 했습니다.</p>\n</li>\n<li>\n<p>테스트케이스중 1개라도 fetch에 실패하면 Promise.all 자체가 에러로 처리됐습니다.<br>\n이것은 Promise.all의 특징인데요, 이름 그대로 ALL or NOTHING으로 처리됩니다..</p>\n</li>\n</ol>\n<p>위의 문제들 때문에 테스트의 실행 시간이 길어지고, 긴 시간을 기다려도 복불복으로 테스트 전체가 실패했습니다.</p>\n<p>첫번째 버전보단 나았지만, 여전히 사용할 수 없는 수준이었죠.</p>\n<h2 id=\"fetch-로직-분리\" style=\"position:relative;\"><a href=\"#fetch-%EB%A1%9C%EC%A7%81-%EB%B6%84%EB%A6%AC\" aria-label=\"fetch 로직 분리 permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>Fetch 로직 분리!</h2>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token comment\">// /__tests__/data/fetch-htmls.ts</span>\n<span class=\"token keyword\">import</span> fs <span class=\"token keyword\">from</span> <span class=\"token string\">'fs'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> chalk <span class=\"token keyword\">from</span> <span class=\"token string\">'chalk'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> Progress <span class=\"token keyword\">from</span> <span class=\"token string\">'progress'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> requestHtml <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../../lib'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> testCases <span class=\"token keyword\">from</span> <span class=\"token string\">'./test-cases.json'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> red<span class=\"token punctuation\">,</span> green<span class=\"token punctuation\">,</span> grey <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> chalk<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> bar <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Progress</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fetching htmls... [:bar] :percent :etas'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  complete<span class=\"token operator\">:</span> <span class=\"token string\">'='</span><span class=\"token punctuation\">,</span>\n  incomplete<span class=\"token operator\">:</span> <span class=\"token string\">' '</span><span class=\"token punctuation\">,</span>\n  width<span class=\"token operator\">:</span> <span class=\"token number\">20</span><span class=\"token punctuation\">,</span>\n  total<span class=\"token operator\">:</span> testCases<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> log <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">fail</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>message<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>red<span class=\"token punctuation\">.</span><span class=\"token function\">inverse</span><span class=\"token punctuation\">(</span><span class=\"token string\">' FAIL '</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function-variable function\">success</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>message<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>green<span class=\"token punctuation\">.</span>inverse<span class=\"token punctuation\">.</span><span class=\"token function\">bold</span><span class=\"token punctuation\">(</span><span class=\"token string\">' SUCCESS '</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">fetchHtmls</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>fileName<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> htmls <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token builtin\">Promise</span><span class=\"token punctuation\">.</span><span class=\"token function\">all</span><span class=\"token punctuation\">(</span>\n      testCases<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>\n        <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> name<span class=\"token punctuation\">,</span> url <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n          <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token builtin\">Promise</span></span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n              <span class=\"token keyword\">const</span> html <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">requestHtml</span><span class=\"token punctuation\">(</span><span class=\"token function\">encodeURI</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n              bar<span class=\"token punctuation\">.</span><span class=\"token function\">tick</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n              <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span>html<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n              log<span class=\"token punctuation\">.</span><span class=\"token function\">fail</span><span class=\"token punctuation\">(</span>name <span class=\"token operator\">+</span> <span class=\"token function\">grey</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">.</span>message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    process<span class=\"token punctuation\">.</span>stdout<span class=\"token punctuation\">.</span><span class=\"token function\">clearLine</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    process<span class=\"token punctuation\">.</span>stdout<span class=\"token punctuation\">.</span><span class=\"token function\">cursorTo</span><span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    log<span class=\"token punctuation\">.</span><span class=\"token function\">success</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\"> fetch complete!</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>__dirname<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>fileName<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">.json</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n    fs<span class=\"token punctuation\">.</span><span class=\"token function\">writeFileSync</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">,</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>htmls<span class=\"token punctuation\">,</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    log<span class=\"token punctuation\">.</span><span class=\"token function\">success</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\"> </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>fileName<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">.json generated ✨</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>red<span class=\"token punctuation\">.</span><span class=\"token function\">inverse</span><span class=\"token punctuation\">(</span><span class=\"token string\">' Error occured!! '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token function\">red</span><span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">fetchHtmls</span><span class=\"token punctuation\">(</span><span class=\"token string\">'test-htmls'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>테스트케이스에 등록되어있는 모든 웹사이트의 HTML을 fetch해서 저장해두는 함수를 만들었습니다.</p>\n<p>덕분에 불안정한 fetch단계만 분리해서 실행할 수 있어 테스트의 안정성이 높아졌습니다.</p>\n<p>또 select 코드만 변경된 경우엔 매번 fetch할 필요 없이 테스트만 돌리면 돼서 성능도 좋아졌습니다!</p>\n<p>progress, chalk 라이브러리를 이용해 인터페이스도 구현했습니다.</p>\n<p>이 방식으로 fetch 로직의 분리는 성공했지만, 위에 존재했던 2가지 문제들중 어느 것도 해결되지 않았습니다.</p>\n<h2 id=\"최종--promiseallsettled-도입-timeout-명확히-지정\" style=\"position:relative;\"><a href=\"#%EC%B5%9C%EC%A2%85--promiseallsettled-%EB%8F%84%EC%9E%85-timeout-%EB%AA%85%ED%99%95%ED%9E%88-%EC%A7%80%EC%A0%95\" aria-label=\"최종  promiseallsettled 도입 timeout 명확히 지정 permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>최종 : Promise.allSettled 도입, timeout 명확히 지정!</h2>\n<div class=\"gatsby-highlight\" data-language=\"tsx\"><pre class=\"language-tsx\"><code class=\"language-tsx\"><span class=\"token comment\">// /__tests__/data/fetch-htmls.ts</span>\n<span class=\"token keyword\">import</span> fs <span class=\"token keyword\">from</span> <span class=\"token string\">'fs'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> chalk <span class=\"token keyword\">from</span> <span class=\"token string\">'chalk'</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">import</span> Progress <span class=\"token keyword\">from</span> <span class=\"token string\">'progress'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> <span class=\"token punctuation\">{</span> allSettled<span class=\"token punctuation\">,</span> requestHtml <span class=\"token punctuation\">}</span> <span class=\"token keyword\">from</span> <span class=\"token string\">'../../lib'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">import</span> testCases <span class=\"token keyword\">from</span> <span class=\"token string\">'./test-cases.json'</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token punctuation\">{</span> red<span class=\"token punctuation\">,</span> green<span class=\"token punctuation\">,</span> grey <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> chalk<span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> bar <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Progress</span><span class=\"token punctuation\">(</span><span class=\"token string\">'fetching htmls... [:bar] :percent :etas'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n  complete<span class=\"token operator\">:</span> <span class=\"token string\">'='</span><span class=\"token punctuation\">,</span>\n  incomplete<span class=\"token operator\">:</span> <span class=\"token string\">' '</span><span class=\"token punctuation\">,</span>\n  width<span class=\"token operator\">:</span> <span class=\"token number\">20</span><span class=\"token punctuation\">,</span>\n  total<span class=\"token operator\">:</span> testCases<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> log <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token function-variable function\">fail</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>message<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>red<span class=\"token punctuation\">.</span><span class=\"token function\">inverse</span><span class=\"token punctuation\">(</span><span class=\"token string\">' FAIL '</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">' '</span> <span class=\"token operator\">+</span> message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n  <span class=\"token function-variable function\">success</span><span class=\"token operator\">:</span> <span class=\"token punctuation\">(</span>message<span class=\"token operator\">:</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>green<span class=\"token punctuation\">.</span>inverse<span class=\"token punctuation\">.</span><span class=\"token function\">bold</span><span class=\"token punctuation\">(</span><span class=\"token string\">' SUCCESS '</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">+</span> <span class=\"token string\">' '</span> <span class=\"token operator\">+</span> message<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">fetchHtmls</span> <span class=\"token operator\">=</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>fileName<span class=\"token operator\">:</span> <span class=\"token builtin\">string</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token keyword\">const</span> htmlDatas <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">allSettled</span><span class=\"token punctuation\">(</span>\n      testCases<span class=\"token punctuation\">.</span><span class=\"token function\">map</span><span class=\"token punctuation\">(</span>\n        <span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> name<span class=\"token punctuation\">,</span> url <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span>\n          <span class=\"token keyword\">new</span> <span class=\"token class-name\"><span class=\"token builtin\">Promise</span></span><span class=\"token punctuation\">(</span><span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span>resolve<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n            <span class=\"token keyword\">try</span> <span class=\"token punctuation\">{</span>\n              <span class=\"token keyword\">const</span> html <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">requestHtml</span><span class=\"token punctuation\">(</span><span class=\"token function\">encodeURI</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n              <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> name<span class=\"token punctuation\">,</span> html <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n              <span class=\"token function\">resolve</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n                name<span class=\"token punctuation\">,</span>\n                html<span class=\"token operator\">:</span> <span class=\"token keyword\">null</span><span class=\"token punctuation\">,</span>\n                message<span class=\"token operator\">:</span> e<span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span>\n              <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span> <span class=\"token keyword\">finally</span> <span class=\"token punctuation\">{</span>\n              bar<span class=\"token punctuation\">.</span><span class=\"token function\">tick</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n            <span class=\"token punctuation\">}</span>\n          <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">)</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">const</span> failedHtmlDatas <span class=\"token operator\">=</span> htmlDatas<span class=\"token punctuation\">.</span><span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>\n      <span class=\"token punctuation\">(</span>htmlData<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token operator\">!</span>htmlData<span class=\"token punctuation\">[</span><span class=\"token string\">'value'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'html'</span><span class=\"token punctuation\">]</span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    failedHtmlDatas<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>htmlData<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      log<span class=\"token punctuation\">.</span><span class=\"token function\">fail</span><span class=\"token punctuation\">(</span>\n        <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>htmlData<span class=\"token punctuation\">[</span><span class=\"token string\">'value'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'name'</span><span class=\"token punctuation\">]</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span> <span class=\"token operator\">+</span> <span class=\"token function\">grey</span><span class=\"token punctuation\">(</span>htmlData<span class=\"token punctuation\">[</span><span class=\"token string\">'value'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'message'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n      <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>failedHtmlDatas<span class=\"token punctuation\">.</span>length<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n      <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token string\">'❗실패한 브랜드는 jest 실행시 다시 fetch합니다❗'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token punctuation\">}</span>\n\n    log<span class=\"token punctuation\">.</span><span class=\"token function\">success</span><span class=\"token punctuation\">(</span>\n      <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">fetch complete! (</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>testCases<span class=\"token punctuation\">.</span>length <span class=\"token operator\">-</span> failedHtmlDatas<span class=\"token punctuation\">.</span>length<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>\n        testCases<span class=\"token punctuation\">.</span>length\n      <span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">)</span><span class=\"token template-punctuation string\">`</span></span>\n    <span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> testHtmls <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n    htmlDatas<span class=\"token punctuation\">.</span><span class=\"token function\">forEach</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span>htmlData<span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n      <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>htmlData<span class=\"token punctuation\">[</span><span class=\"token string\">'value'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'html'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n        testHtmls<span class=\"token punctuation\">[</span>htmlData<span class=\"token punctuation\">[</span><span class=\"token string\">'value'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'name'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> htmlData<span class=\"token punctuation\">[</span><span class=\"token string\">'value'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token string\">'html'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n      <span class=\"token punctuation\">}</span>\n    <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n    <span class=\"token keyword\">const</span> path <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>__dirname<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>fileName<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">.json</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n    fs<span class=\"token punctuation\">.</span><span class=\"token function\">writeFileSync</span><span class=\"token punctuation\">(</span>path<span class=\"token punctuation\">,</span> <span class=\"token constant\">JSON</span><span class=\"token punctuation\">.</span><span class=\"token function\">stringify</span><span class=\"token punctuation\">(</span>testHtmls<span class=\"token punctuation\">,</span> <span class=\"token keyword\">undefined</span><span class=\"token punctuation\">,</span> <span class=\"token number\">2</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'utf-8'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    log<span class=\"token punctuation\">.</span><span class=\"token function\">success</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>fileName<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">.json generated ✨</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">(</span>e<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n    <span class=\"token builtin\">console</span><span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span>red<span class=\"token punctuation\">.</span><span class=\"token function\">inverse</span><span class=\"token punctuation\">(</span><span class=\"token string\">' Error occured!! '</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token function\">fetchHtmls</span><span class=\"token punctuation\">(</span><span class=\"token string\">'test-htmls'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>현재 프로덕션에 적용된 최종 코드입니다. 이전 버전과 유사하지만 결정적인 개선점들이 있습니다.</p>\n<ol>\n<li>timeout 제한을 엄격하게 관리<br>\n모든 fetch request에 timeout을 명시하고, 모든 case에서 request 시간의 합이 일정하도록 조절한다.</li>\n<li>allSettled 도입 <br>\nPromise.all과 다르게 일부 case가 reject되더라도 온전히 데이터를 반환합니다. Promise.allSettled를 그냥 사용하면 node 버전 호환 문제가 발생해 인터넷에 공개된 polyfill 코드를 그대로 사용했습니다. <a href=\"https://github.com/ppeeou/makelib/blob/master/Promise/allSettled.js\">출처</a></li>\n<li>bar.tick() 함수를 finally문으로 분리해서 에러시에도 일단 로딩이 진행되도록 했습니다. 별거 아닌 것 같지만 답답함이 크게 개선되었습니다!</li>\n<li>fetch 실패시 안내 문구들을 추가했습니다.</li>\n</ol>\n<h2 id=\"결과\" style=\"position:relative;\"><a href=\"#%EA%B2%B0%EA%B3%BC\" aria-label=\"결과 permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>결과</h2>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 426px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 29.000000000000004%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAGCAYAAADDl76dAAAACXBIWXMAAAsTAAALEwEAmpwYAAABQklEQVQY022Ry2rCQBiFfRG7j1YTk3hP0sSYy0RzcVIj1AqFglDaTemTdNFNX/YrMzuhi48zM3B+zn+m56YC93LFKVvc5sS0emSanZkGBU/rgJfFnGDu4z+47HY7ttst+/0eIQTj8fiG0WhEr6grRFVRlCVJLqgOB5JMYFoWjmUxtW0mkwmOY+M4jj5blqUZDocYhqFVoYb2cj+ijFOKaEsUhvi+z2q1JPB9NpsNuRCkaaqJ45gsy8jznCiK9FuSJHiep9EJF18Xlp+KZ/Z1RStbgiBASknbttqsjGVZUte1vq89j9lsThiGugIVQnn0wP7vB3c/b/S/rxR1yaFukK3kdDrpIU3T6M7O5zPH4xEpW0LPwTLvMYwBg8HgduW1TDi8v7LpatIs0ym6rtN9qZ5s28Z1Xa2qP6X2xMQ0x/9+yh8e9dHNfDobWQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Fetch 스크린샷\"\n        title=\"Fetch 스크린샷\"\n        src=\"/static/f89a0fb1a44b85b47b731afd9f61f74c/531e1/screen-shot-fetch.png\"\n        srcset=\"/static/f89a0fb1a44b85b47b731afd9f61f74c/772e8/screen-shot-fetch.png 200w,\n/static/f89a0fb1a44b85b47b731afd9f61f74c/e17e5/screen-shot-fetch.png 400w,\n/static/f89a0fb1a44b85b47b731afd9f61f74c/531e1/screen-shot-fetch.png 426w\"\n        sizes=\"(max-width: 426px) 100vw, 426px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<center>fetch 실행 결과</center>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 555px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 74%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAPCAYAAADkmO9VAAAACXBIWXMAAAsTAAALEwEAmpwYAAACVklEQVQ4y4WUXW7jNhRGvZO+tAhikZIoSpRISpZ/Yg/G1iiJB4hRBGmD+qX76BK6oi6gazoD0k5qBwH6cHBJQrq633evOJkv7+geDnTjI/P9Abd5wNQzRq3xWlPVGu89bdeiteZmOuWX6ZRbIUjTFCllJKwDk8V+h/+ywFYVfesxVYlSOVIpKmNo2w5T19imoShLVs7xMJuxMgZxkeg94U9//8nPf73itKHre5qmoe97urZlHEdeXl54enpifHzkt2Hgn9dX/j0e+WM+50YIso8Jm3HDYj+w2XxBlyVplr2T53mkKArSPMcpxVaXLJQi+SD1PaG8TbC6ZNY0eGOwWlMIgZISIUR86S0mQnAjkpN/IdkZecFEpClGKeZFQVcU9CEqRZPnp0rDl7P8HDOyeJ4jI1kknp+fncSyswxtDFXToMqS2lqs99TGkOkS0c4RjUO4DtH2J3yPcDMS11FYd2paUTCRaUpT1/TW0oZuliWFlNHsKCNUEdZv8UyUevbtU8nrs9Q+mB8eOvsWfQqeRd/ExVqe9lJcz2HYBF+quo5SS1NhvcO3PlaelRWiWyAaHyVG+ZGT7MTNKKz/T3LoYDBUKRVjJiR5IM1IZRqHN3mTHrluyFtT3is8HA6M9/cMX7fUqxnJYYP8fcDsVgzbHcMwxGG/HJOPXHl4PB55fn7GWUflLZtf99wd7knbGudc/I+ttVc+yQ9cDfb373vuVkvq2kQfHnbf+LreIKcJ03AJ3N6SJMmnF8FnTLzVrLc75ssly/Wa7bcRY13scqFLjDH/m+Qy4Q86+eYMQiEmzwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Jest 스크린샷\"\n        title=\"Jest 스크린샷\"\n        src=\"/static/4cc2d89548d7c93c22b805d22d278353/cd039/screen-shot-jest.png\"\n        srcset=\"/static/4cc2d89548d7c93c22b805d22d278353/772e8/screen-shot-jest.png 200w,\n/static/4cc2d89548d7c93c22b805d22d278353/e17e5/screen-shot-jest.png 400w,\n/static/4cc2d89548d7c93c22b805d22d278353/cd039/screen-shot-jest.png 555w\"\n        sizes=\"(max-width: 555px) 100vw, 555px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<center>jest 실행 결과</center>\n<p>295개의 테스트케이스를 7초, 18초만에 처리하는 준수한 성능을 갖게 됐습니다 ✨</p>","tableOfContents":"<ul>\n<li><a href=\"#%ED%95%94-%ED%81%AC%EB%A1%A4%EB%9F%AC%EA%B0%80-%EB%AD%94%EA%B0%80%EC%9A%94\">핔 크롤러가 뭔가요?</a></li>\n<li><a href=\"#%EC%99%9C-%EA%B0%91%EC%9E%90%EA%B8%B0-%ED%85%8C%EC%8A%A4%ED%8A%B8%EB%A5%BC-%EB%8F%84%EC%9E%85%ED%96%88%EB%82%98%EC%9A%94\">왜 갑자기 테스트를 도입했나요?</a></li>\n<li><a href=\"#%EC%B2%AB-%EB%B2%88%EC%A7%B8-%EB%B2%84%EC%A0%84--%EC%9E%98-%EC%9E%91%EB%8F%99%ED%95%98%EC%A7%80%EB%A7%8C-%EC%84%B1%EB%8A%A5%EC%9D%B4\">첫 번째 버전 : 잘 작동하지만 성능이..?</a></li>\n<li><a href=\"#%EB%B3%91%EB%A0%AC-%EC%B2%98%EB%A6%AC--promiseall\">병렬 처리 : Promise.all</a></li>\n<li><a href=\"#fetch-%EB%A1%9C%EC%A7%81-%EB%B6%84%EB%A6%AC\">Fetch 로직 분리!</a></li>\n<li><a href=\"#%EC%B5%9C%EC%A2%85--promiseallsettled-%EB%8F%84%EC%9E%85-timeout-%EB%AA%85%ED%99%95%ED%9E%88-%EC%A7%80%EC%A0%95\">최종 : Promise.allSettled 도입, timeout 명확히 지정!</a></li>\n<li><a href=\"#%EA%B2%B0%EA%B3%BC\">결과</a></li>\n</ul>","fields":{"slug":"/retrospective/001-pickk-crawl-jest/"},"frontmatter":{"title":"핔 크롤러 테스팅 도입기","date":"2020-11-19T18:44:10.169Z","tags":["jest","ci"],"thumbnail":{"childImageSharp":{"fluid":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAYAAABiDJ37AAAACXBIWXMAAAsTAAALEwEAmpwYAAACRklEQVQoz5WT60tTYRzHl3M7Z56zcxlOg6jMArt4bZr3rV10qZmEszFnTSUqLC9gIUVCQRczMwwk58JLSNCL3vTGF/0HEr3pD/rEeXLTVQi9+PKD8zvP5/n+Lo/NMAz+V4rmZvx8mPWOG7wPDbISGiQdTgrZ9v+o67qIHtMUMk0z982KHsNEUhUiJyvZ6Ej9BcsDZg+qqopDlpCUIiRZzuVMK6e5OeYt5W1ggNXwUA64sg+cA1puVEWhrraWmTv3mEikGB5MorrdAmblrVKnfBG2oiOshpNCmfCQgFvRgtqs20U5Hg8F9gJOna5g++UyO89XmB69jdMli1LtkpPWsgoeNF5iprGLeX8/74JxJusjPGrq5llrn4Dasu4kWaL/8hVS8QSfMmv8/P6D0eR1Ch2FeEtKiHX1MH8xxkR9hFRVKyM17QIcP9fIuC/Mi7arZCK7QMvdIbudzOISW5ubfJ1fZmdulbWFJQpliQafj+30Bp/jE9ys8ZOoama2pZf7DVESlc0MV7fl91DXNDwlXtafvOLb0yW+jM3ycXKWkWsJbJKDYPlZ1vtukQ4ledjUTaK6hakLnbz2x3jc3MNoTfteD0XJhkGRqhDr7mXu7jRd0ShHystwuGSOFpeyGBggE0qKAx8iQ7wJDIgeZldlOZgQA9obijVpXUd2uXAUuXA6nWiqiqJrjNUF2ez8vXPp3UOWGwu8f13y10Y30A1dDMda6GKPB8mtEDhxJu81HKQs1Pavp+XWNI57D7Pgjwkn7/9wcZB+AfrRp+OrPSpTAAAAAElFTkSuQmCC","aspectRatio":1.6216216216216217,"src":"/static/43e3127c15bd4483264f56ef7310193f/f3583/jest-pickk.png","srcSet":"/static/43e3127c15bd4483264f56ef7310193f/630fb/jest-pickk.png 300w,\n/static/43e3127c15bd4483264f56ef7310193f/2a4de/jest-pickk.png 600w,\n/static/43e3127c15bd4483264f56ef7310193f/f3583/jest-pickk.png 1200w,\n/static/43e3127c15bd4483264f56ef7310193f/fdd2f/jest-pickk.png 1596w","sizes":"(max-width: 1200px) 100vw, 1200px"}}}}}},"pageContext":{"slug":"/retrospective/001-pickk-crawl-jest/","previous":{"excerpt":"Nextjs 공식 블로그의 Next.js 10를 번역 및 요약한 글입니다.의역 및 개인적인 의견이 많이 추가될 예정입니다. 와! Next.js 10! 지난 Next conf와 함께 Next.js 10이 공개되었다. 언제나 실망시키지 않는 Vercel…","fields":{"slug":"/trans/001-next-10/"},"frontmatter":{"date":"2020-11-19T00:13:38.169Z","title":"Next.js 10, 뭐가 바뀌었을까?","layout":"post","thumbnail":{"childImageSharp":{"fluid":{"originalImg":"/static/23c6a21b34eaca00c98dae5e2e36fcad/ec6c5/nextjs.jpg"}}}}},"next":{"excerpt":"express.js는 가장 유명한 Node.js기반 웹프레임워크다. 이미 조약하게나마 몇번 써본 경험이 있기 때문에 Hello World는 건너 뛰고, 프로답게 사용하기 위한 방법/팁들을 배우고 정리해보겠다. Bulletproof node.js…","fields":{"slug":"/til/008-express/"},"frontmatter":{"date":"2020-11-22T18:35:10.169Z","title":"Express.js 서버 개발 첫걸음 딛기","layout":"post","thumbnail":{"childImageSharp":{"fluid":{"originalImg":"/static/8b67d1064dc6b182de524fd187b0331f/22701/expressjs.png"}}}}}}},"staticQueryHashes":["1845200029","3000541721"]}
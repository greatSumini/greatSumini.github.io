{"componentChunkName":"component---src-templates-blog-post-tsx","path":"/guide/002-django-migration-rollback-regenerate/","result":{"data":{"site":{"siteMetadata":{"title":"최수민 개발 블로그","siteUrl":"https://sumini.dev"}},"markdownRemark":{"id":"f38160d9-36e7-5afe-b231-575ef28b4078","excerpt":"feature 브랜치에서 작업하던중 develop 브랜치에 새로운 변경 사항들이 생겼다. 확인해보니 두 브랜치에서 같은 app내의 모델을 수정해, 넘버링이 겹치는 문제가 생겼다. 😅 remote 브랜치의 migrations를 보존하면서 local 브랜치의 migration…","html":"<p>feature 브랜치에서 작업하던중 develop 브랜치에 새로운 변경 사항들이 생겼다.</p>\n<p>확인해보니 두 브랜치에서 같은 app내의 모델을 수정해, 넘버링이 겹치는 문제가 생겼다. 😅</p>\n<p>remote 브랜치의 migrations를 보존하면서 local 브랜치의 migration들을 정리해보자!</p>\n<h2 id=\"1-migration-conflict-해결\" style=\"position:relative;\"><a href=\"#1-migration-conflict-%ED%95%B4%EA%B2%B0\" aria-label=\"1 migration conflict 해결 permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>1. migration conflict 해결</h2>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">$ <span class=\"token function\">git</span> pull origin <span class=\"token operator\">&lt;</span>remote_branch_name<span class=\"token operator\">></span></code></pre></div>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 130px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 80.76923076923077%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAQCAYAAAAWGF8bAAAACXBIWXMAAAsTAAALEwEAmpwYAAADkUlEQVQ4y0WU6VIbRxSFlarkDVJOwJqtp2dG+wbWiiWhDYEQaAPHkuMCl2NjJCMwS7ADqfxw/CMvkFTyBskL+C3yAHmYLzUtyv5x6ty+XVPd9/Q5E3CEhRUvsFR/hXQ8HOlQq9WpVCpUq1Wq1XUqlaqqhbAJhcJkMivk8wWKxRKRSJRms0UikaRebxCwnQjxZzf8+OdL3k3v4bgpZtNjzs7ecH19zYcPH7i5ueX09IzV1Qfc3NxwcXGh+OTkhFgszvX1W87Pz7m9/ZnAsh7j4DDBv/98QaNsYgmPVqtFrV6n0WiysdFmo91mu9tlMBgqbG11aLc32d3t0Wy11BSdTod6o0FASoeQrRNxTYKah+M4GEEDQ/sMPahj6v5hAl03MHTz057/vWlaGOaiF3BtCz3T5NvuO+JxF2lLooUMkQcpItnUgnNpwqtJpa9jO3jRCKFkjPBKEsd1cVwPR0jCmQQBy4mRP37L73/3+WV+D82Jkfthm9y0T+FsxNrthML5nlp7iSi51wNyr3YpvNkj+6KLGw0rzh7tUrx8ROC+HmGyL/n4x5c8yAiE9Eh3yyS3y6R2KqSHNVLbZTKjOqndKqtPN0mPaqqf3quT2CiSedQks98g1a0Q8DUTpkBbNhHCVWP5Wpg+fC2DutLUMiw1mm0IpGUv2JY4nqfW0rQVBxxbIKNp9LU9TMtDSkmhWCSbzSnk8nkKhaKyjG1L7LtHkI6rfOnDErbqWZYgoMz83Vse//aOk8MlXC/JdHrM/PSUq6sr3r//lcvLK2azGel0Rnnv4uKS+XzObPaao6Mjnj9/znx+ynQ6I7BkxDk8LvHfx68YdTQsEabX22VnZ4d+v89wOKQ/GDAej9nc3FKYTCYqHZ3ONqPRHr1ej+FwxHg8IWDbDgkvyFpmiaC+8KHvO10z0II62n2d+8tBNZqfCl3T0TR94T3DVPC9qXr+yL4PjViJryvHuL7Avg9TCcLxqOJYOkF8NYUbCiFdl0g8hrQkrushhUToQtW+P/36U5av/3rJT9NvMOwItSdtGs92qIzbrH+/RfNFj/TDLNmNNVovejzca2JbNqV+jcrjttpff9qhvN+6y/JBXGW5/tBEyBBr/RqlQV0hVVql0K2S75RZWc+T3ypTO9gmWVihOt6kftil+mRTYf3J1iLLnhSEQi6asfh92UKqGyi+q30JfAhDIEyb2EpS5djSrEXPEFi6xf9ZHRyU72IwmQAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Local conflict\"\n        title=\"Local conflict\"\n        src=\"/static/4a3080000063031628b5caa463fbb92d/ffd64/1_local_conflict.png\"\n        srcset=\"/static/4a3080000063031628b5caa463fbb92d/ffd64/1_local_conflict.png 130w\"\n        sizes=\"(max-width: 130px) 100vw, 130px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>위 사진과 같이 69번 migration이 중복으로 생성된 것을 확인할 수 있다!<br>\nroll back 후 다시 migration을 생성해 해결해보자</p>\n<br>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># conflicted migration files 삭제</span>\n$ <span class=\"token function\">rm</span> 0069_add_selects_request.py\n$ <span class=\"token function\">rm</span> 0070_fix_selects_request_sns_link,content.py</code></pre></div>\n<p>local 브랜치에서 작업한 migration 파일들을 모두 삭제한다.</p>\n<br>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># migration 롤백 후 remote 적용</span>\n$ ./manage.py migrate items 0068_add_follwers_count.py\n$ ./manage.py migrate</code></pre></div>\n<p>base 상태로 되돌아간 후 <code class=\"language-text\">migrate</code> 명령어를 실행해 remove 브랜치의 migration을 적용한다.</p>\n<br>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># migration 재생성</span>\n$ ./manage.py makemigrations items</code></pre></div>\n<p>local 브랜치의 변경을 반영하기 위한 migration 파일을 새로 생성한다! 이후 파일명을 적절하게 바꿔준다.</p>\n<br>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 153px; \"\n    >\n      <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50.980392156862756%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAYAAAC0VX7mAAAACXBIWXMAAAsTAAALEwEAmpwYAAACX0lEQVQozz2Q204TYRSF5wH0wniB9HycmZZ2OjOlpynt9ERpSxBaWjQ1YCqFcD6VFAqCeKGJt974BN4Y38FH+8z8iV7srL3W3vn/tbYUSyRQNIP5xiGxdBbN0Gm02tSWmyy32jTbHSr1BspCAs0wsUplrLJNOpfHrtXJFCwaKy2ShilKUlUFtT3ky889HiZezGyF6e2U88srPj5+4vHpiePTM9Z7m6K/nk65md2Jjxz9enrD49NnsT+9nSHJ8SR61uTHwzPqdgR5wSBnWWTyBRbzBeGgVKmy0lmlXK0Jh6VqlXpzRcwcnrWKFEplCkslpKisEAkGeREo8sqXRI5GkBUVWVaIRuX/6PcHcHu8eJzy+vD6/Hi9PtxuD/5AEJ/PL3QpGgwQKnSo3H9lZxhBTy1ycnLM/v4+V1cTLi+v2N0dUyhYjHfHjEYfGI1GDIfv2Np6w3g8pmJXsG2b7e0dpFAgRHLJ5s9vF3tv54gqBr1el7W11/T7fbrdHoPBFq1Wm42NLpubfTqdVTFzuPPo+vqG2On3B0gRJ1bITzo2h8crEwqFRQwnmoPz8y4CgSDhcERwl8uN2+0VEf9xZ+6cxOmlaCRCWNV4WT0jYWok4nHhZnm5SbvdEQ5NM42iqORyOer1OqVSGVWNCd2yihSLS2haCtuuIIX9fpTGgO+/hjycz5HU8lxcnHN0dCTu5GC322Vn5z339/fMZnccHBxQq9VFP5lcM5vNODw84uTkFCkUlkkkFb5dPidrBgmFVXRdJ5XSiccXhJN/LgzDRNcNMpms0NLpRVKplHDn6Mmkxl/N6l++Yw539wAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"Result\"\n        title=\"Result\"\n        src=\"/static/fcc3c2bbf66ce2959b404671207f1af7/3bda9/2_result.png\"\n        srcset=\"/static/fcc3c2bbf66ce2959b404671207f1af7/3bda9/2_result.png 153w\"\n        sizes=\"(max-width: 153px) 100vw, 153px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n    </span></p>\n<p>깔끔하게 반영됐다 ㅎ</p>\n<h2 id=\"2-db-conflict-해결\" style=\"position:relative;\"><a href=\"#2-db-conflict-%ED%95%B4%EA%B2%B0\" aria-label=\"2 db conflict 해결 permalink\" class=\"anchor-header before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>2. DB conflict 해결</h2>\n<p>migrate 후에 테스트를 돌려보니 <span style=\"color:red\">django.db.utils.ProgrammingError: relation already exists</span> 에러가 발생했다!</p>\n<p>이유는 rollback전에 생성한 local migration에서 이미 새로운 모델의 relation을 생성했는데, rollback하고 다시 생성하는 과정에서 relation이 삭제되지 않고 남아있던 것이다.</p>\n<p>이를 해결하기위한 여러가지 방법이 있지만, 실수 가능성 없이 깔끔하게 해결하기 위해 DB를 초기화 해보겠다.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\"><span class=\"token comment\"># postgresql cli 접속</span>\n$ psql\n\n<span class=\"token comment\"># 데이터베이스 drop후 재생성</span>\n<span class=\"token assign-left variable\">postgres</span><span class=\"token operator\">=</span><span class=\"token comment\"># drop database &lt;local_db_name>;</span>\n<span class=\"token assign-left variable\">postgres_test</span><span class=\"token operator\">=</span><span class=\"token comment\"># create database &lt;local_db_name> encoding 'utf-8';</span>\n<span class=\"token assign-left variable\">postgres_test</span><span class=\"token operator\">=</span><span class=\"token comment\"># grant all privileges on database &lt;local_db_name> to &lt;local_user_name>;</span>\n\n<span class=\"token comment\"># production db dump</span>\n$ pg_dump <span class=\"token parameter variable\">-U</span> <span class=\"token operator\">&lt;</span>user_name<span class=\"token operator\">></span> <span class=\"token parameter variable\">-h</span> <span class=\"token operator\">&lt;</span>host<span class=\"token operator\">></span> <span class=\"token parameter variable\">-p</span> <span class=\"token operator\">&lt;</span>port_number<span class=\"token operator\">></span> <span class=\"token parameter variable\">-d</span> <span class=\"token operator\">&lt;</span>db_name<span class=\"token operator\">></span> <span class=\"token operator\">></span> production.sql\n$ psql <span class=\"token operator\">&lt;</span>local_db_name<span class=\"token operator\">></span> <span class=\"token parameter variable\">-U</span> <span class=\"token operator\">&lt;</span>local_user_name<span class=\"token operator\">></span> <span class=\"token operator\">&lt;</span> production.sql</code></pre></div>\n<ol>\n<li>local db를 drop후 재생성한다.</li>\n<li>서비스중인 production db를 dump해서 가져온다.</li>\n<li>dump한 파일 내용을 local db에 적용한다.</li>\n</ol>\n<p>다시 테스트를 실행하면 잘 돌아간다 ✨</p>","tableOfContents":"<ul>\n<li><a href=\"#1-migration-conflict-%ED%95%B4%EA%B2%B0\">1. migration conflict 해결</a></li>\n<li><a href=\"#2-db-conflict-%ED%95%B4%EA%B2%B0\">2. DB conflict 해결</a></li>\n</ul>","fields":{"slug":"/guide/002-django-migration-rollback-regenerate/"},"frontmatter":{"title":"Django migration 롤백, 재생성 방법","date":"2020-09-15T02:27:10.169Z","tags":["django","migration"],"thumbnail":{"childImageSharp":{"fluid":{"base64":"data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAYAAAAIy204AAAACXBIWXMAAAsTAAALEwEAmpwYAAABDElEQVQoz3WQWY6EMAxEuf+5uhu+G3GEYc1GErZAUiMbgcRIE6l+4vJz2VkIO5yfoLVB1/cYhGD1/YDX6w1rLWJK7DFmRD8MkFKxlFIQUrJfKoVlWZBdQCp2XX9CB4G6aVAUxQmMCdZ5KKUfHhqqtWboOFrQY6BnoL6NV9r35wPvPWKMcN5DG8MQTkQJtWZRjxlHpHQBpwmjtRybmqhIpjzPH0BDwOEEUiqCEVgIwefYtg3ZFgKc85jn+RGdIFVVwTl3r8zrCcmD266DlBI/dc3DCdy0LbKUEkgEOI6DRYAQAr7fLwOPGBlIR6dz0F8CcPVe4hvin7fvO8qyvJuXdcW6rrz6NE08lEL81S/sqRfFGYBiUgAAAABJRU5ErkJggg==","aspectRatio":2.6785714285714284,"src":"/static/ff30f46b8b7bd2e06ace543fcf0e41fc/8c781/0_conflict.png","srcSet":"/static/ff30f46b8b7bd2e06ace543fcf0e41fc/630fb/0_conflict.png 300w,\n/static/ff30f46b8b7bd2e06ace543fcf0e41fc/8c781/0_conflict.png 505w","sizes":"(max-width: 505px) 100vw, 505px"}}}}}},"pageContext":{"slug":"/guide/002-django-migration-rollback-regenerate/","previous":{"excerpt":"window.location.search를 읽어, 사용하기 좋은 object 형태로 만들어야 한다. 이를 구현할 수 있는 여러 라이브러리(react-router, react-router-dom, use-react-router…","fields":{"slug":"/guide/001-how-to-get-query-parameters-using-react-hooks/"},"frontmatter":{"date":"2020-09-10T02:41:10.169Z","title":"Query Parameter Hook 만들기","layout":"post","thumbnail":{"childImageSharp":{"fluid":{"originalImg":"/static/3637df1098a590708a1fd467f0768599/f9913/hooks.jpg"}}}}},"next":{"excerpt":"Next.js 개발환경에서 window object를 사용할 때, document is undefined, Cannot read innerWidth of undefined 등의 에러메세지를 마주할 때가 있다. Next.js…","fields":{"slug":"/issue/000-nextjs-window,document-is-not-defined/"},"frontmatter":{"date":"2020-09-15T03:19:10.169Z","title":"Next.js \"window,document is not defined\" 해결하는 법","layout":"post","thumbnail":{"childImageSharp":{"fluid":{"originalImg":"/static/bbc016fa1685c64a2b61da4817186d6c/3225f/nextjs.png"}}}}}}},"staticQueryHashes":["1845200029","3000541721"]}